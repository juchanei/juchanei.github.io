<!DOCTYPE html><html lang="ko"><head><meta charSet="utf-8"/><link rel="stylesheet" href="/_next/static/css/d32bf43455ded298.css" data-precedence="next"/><link rel="stylesheet" href="/_next/static/css/e175a87955b7f53c.css" data-precedence="next"/><link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/atom-one-light.min.css"/><link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/atom-one-dark.min.css" media="screen and (prefers-color-scheme: dark)"/><link rel="preload" as="script" href="https://www.googletagmanager.com/gtag/js?id=G-JRWY82TBQY"/><title>juchanei</title><meta name="description"/><meta property="og:site_name" content="juchanei"/><meta property="og:type" content="blog"/><meta property="og:title" content="juchanei"/><meta property="og:image" content="/logo_transparent.png"/><meta property="og:url" content="https://juchanei.github.io"/><meta property="og:description"/><meta property="og:locale" content="ko_KR"/><meta name="twitter:card" content="summary"/><meta name="twitter:title" content="juchanei"/><meta name="twitter:description"/><meta name="twitter:image" content="/logo_transparent.png"/><meta name="google-site-verification" content="zMe30NikxkVrHQc8KL1LeFDlYRx13BypWzaXpglLe3Q"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/atom-one-light.min.css"/><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/atom-one-dark.min.css" media="screen and (prefers-color-scheme: dark)"/><script src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js" noModule=""></script></head><body><main class="Layout_main__maYPe"><header><a class="Layout_logo__tEsDc" href="/">juchanei</a><nav><ul><li><a href="/about">about</a></li><li><a href="/articles">articles</a></li><li><a target="blank" href="https://github.com/juchanei">github</a></li></ul></nav></header><article><h1>Sagas</h1><time>November 22, 2022</time><hr class="Article_bar__LgwyR"/><div class="Article_blog-post-content__vjQ_B"><blockquote>
<p><a href="https://microservices.io/patterns/data/saga.html">https://microservices.io/patterns/data/saga.html</a> 을 번역한 글입니다.</p>
</blockquote>
<h2 id="context">Context</h2>
<p>당신은 <a href="https://microservices.io/patterns/data/database-per-service.html">Database per Service</a> 패턴을 적용했다. 각각 의 서비스는 자신만의 데이터베이스를 가지고 있다. 그런데, 한 비즈니스 트랜잭션이 여러 서비스에 걸쳐 존재하고 당신은 이를 구현하기 위한 메커니즘이 필요하다. 예를 들어, 구매자에게 신용한도가 있는 e-커머스 스토어를 만든다고 해보자. Order 서비스와 Customer 서비스는 각각의 데이터베이스를 가지고 있어 로컬 ACID 트랜잭션을 쓸 수 없는 상태이다.</p>
<h2 id="problem">Problem</h2>
<p>어떻게 하면 여러 서비스에 걸쳐 트랜잭션을 구현할 수 있을까?</p>
<h2 id="forces">Forces</h2>
<ul>
<li>2PC (2 Phase Commit)은 사용하지 않는다.</li>
</ul>
<h2 id="solution">Solution</h2>
<p>여러 서비스에 걸친 비즈니스 트랜잭션은 saga로 구현한다. Saga는 연속된 로컬 트랜잭션이다. 각각의 로컬 트랜잭션은 데이터베이스를 업데이트하고 메시지나 이벤트를 발행해 saga 다음 트랜잭션을 트리거한다. 만약 비즈니스 규칙을 위반하여 로컬 트랜잭션이 실패하면 saga는 이전 트랜잭션으로 인한 변화를 되돌리기 위해 보상 트랜잭션들을 실행한다.</p>
<p><img src="https://user-images.githubusercontent.com/10704195/203361071-e470cbd0-840e-4d89-b7aa-392a917c9c29.png" alt="image"></p>
<p>여기에 saga를 조정(coordination)하는 두 방식이 있다.</p>
<ul>
<li>Choreography - 각각의 로컬 트랜잭션이 다른 서비스의 로컬 트랜잭션을 트리거 하는 도메인 이벤트를 발행한다.</li>
<li>Orchestration - 오케스트레이터가 다른 서비스들에게 로컬 트랜잭션을 실행하도록 지시한다.</li>
</ul>
<h2 id="example-choreography-based-saga">Example: Choreography-based saga</h2>
<p><img src="https://user-images.githubusercontent.com/10704195/203361160-6d81af0f-c692-43e6-8f11-a53c29404164.png" alt="image"></p>
<p>e-커머스 어플리케이션이 choreography 기반의 saga를 사용하여 ‘주문’을 생성하려고 한다면, 아래 단계를 따른다.</p>
<ol>
<li><code>Order</code> 서비스는 <code>POST /orders</code> 요청을 받고 <code>Order</code>를 <code>PENDING</code> 상태로 생성한다.</li>
<li><code>Order Created</code> 이벤트를 발행한다.</li>
<li><code>Customer</code> 서비스의 이벤트 핸들러가 이를 받아 ‘신용’을 확보한다.</li>
<li>위 결과를 의미하는 이벤트를 발행한다.</li>
<li><code>Order</code> 서비스의 이벤트 핸들러가 <code>Order</code>를 승인하거나 거절한다.</li>
</ol>
<h2 id="example-orchestration-based-saga">Example: Orchestration-based saga</h2>
<p><img src="https://user-images.githubusercontent.com/10704195/203361191-38660bcb-38c5-4de0-a6f7-4b1ac500c21f.png" alt="image"></p>
<p>e-커머스 어플리케이션이 orchestration 기반의 saga를 사용하여 ‘주문’을 생성하려고 한다면, 아래 단계를 따른다.</p>
<ol>
<li><code>Order</code> 서비스가 <code>POST /orders</code> 요청을 받고 <code>Create Order</code> saga 오케스트레이터를 생성한다.</li>
<li>saga 오케스트레이터는 <code>Order</code>를 <code>PENDING</code> 상태로 생성한다.</li>
<li>그리고 <code>Reserve Credit</code> 명령(command)를 <code>Customer</code> 서비스로 보낸다.</li>
<li><code>Customer</code> 서비스는 ‘신용’을 확보한다.</li>
<li><code>Customer</code> 서비스는 결과를 saga 오케스트레이터에게 보낸다.</li>
<li>saga 오케스트레이터는 <code>Order</code>를 승인하거나 거절한다.</li>
</ol>
<h2 id="resulting-context">Resulting context</h2>
<p>이 패턴은 다음과 같은 장점이 있다.</p>
<ul>
<li>분산 트랜잭션 없이 여러 서비스에 걸쳐 데이터 일관성을 유지할 수 있도록 한다.</li>
</ul>
<p>이  패턴은 다음과 같은 단점이 있다.</p>
<ul>
<li>프로그래밍 모델이 복잡하다. 예를 들어, 개발자는 앞선 변화를 되돌릴 수 있도록 반드시 보상 트랜잭션을 설계해야 한다.</li>
</ul>
<p>이 패턴은 또한 아래 대처해야 할 이슈가 있다.</p>
<ul>
<li>신뢰성을 위해 서비스는 반드시 원자적으로 데이터베이스를 업데이트 한 후 메시지/이벤트를 발행해야 한다. 이때 데이터베이스와 메시지 브로커에 걸친 분산 트랜잭션 메커니즘은 사용할 수 없다. 대신, 다음에 소개 될 아래 패턴 중 하나를 사용해야 한다.</li>
<li>클라이언트는 동기적인 요청(e.g. HTTP <code>POST /orders</code>)을 통해 saga를 동작 시키고, 그 결과를 비동기적으로 얻어야 한다. 여기에는 트레이드오프가 있는 몇가지 옵션이 있다.<ul>
<li>서비스는 saga가 완료되면 그 결과를 응답한다. (e.g. <code>OrderApproved</code> 또는 <code>OrderRejected</code> 이벤트)</li>
<li>서비스는 saga를 동작시킨 뒤 <code>orderID</code>를 포함하여 응답한다. 클라이언트는 주기적으로 <code>GET /orders/{orderID}</code>를 요청해 polling 하여 결과를 얻는다.</li>
<li>서비스는 saga를 동작시킨 뒤 <code>orderID</code>를 포함하여 응답한다. 그리고 saga가 완료되면 웹 소캣 또는 웹 훅 등을 이용해 이벤트를 발행한다.</li>
</ul>
</li>
</ul>
<h2 id="related-patterns">Related patterns</h2>
<ul>
<li>이 패턴은 <a href="https://microservices.io/patterns/data/database-per-service.html">Database per Service pattern</a>의 필요로 인해 고안됐다.</li>
<li>아래 패턴 들은 <em>원자적으로</em>  업데이트와 메시지/이벤트를 발행하는 방법이다.<ul>
<li><a href="https://microservices.io/patterns/data/event-sourcing.html">Event sourcing</a></li>
<li><a href="https://microservices.io/patterns/data/transactional-outbox.html">Transactional Outbox</a></li>
</ul>
</li>
<li>Choreography 기반 saga는 <a href="https://microservices.io/patterns/data/aggregate.html">Aggregates</a>와 <a href="https://microservices.io/patterns/data/domain-event.html">Domain Events</a>를 사용해 이벤트를 발행한다.</li>
</ul>
<h2 id="learn-more">Learn more</h2>
<ul>
<li>책 <a href="https://microservices.io/book">Microservices patterns</a>는 이 패턴에 대해 상세히 설명한다. 이 책의 <a href="https://github.com/microservice-patterns/ftgo-application">example application</a>은 <a href="https://github.com/eventuate-tram/eventuate-tram-sagas">Eventuate Tram Sagas framework</a>를 사용한 orchestration 기반의 saga로 구현되어있다.</li>
<li><a href="https://chrisrichardson.net/virtual-bootcamp-distributed-data-management.html">self-paced, online bootcamp</a>에서 여러 서비스에 걸쳐 saga를 사용하는 방법, API Composition, CQRS 패턴을 배울 수 있다.</li>
<li>Saga 패턴에 관한 블로그 포스트<ul>
<li><a href="https://chrisrichardson.net/post/antipatterns/2019/07/09/developing-sagas-part-1.html">overview of sagas</a></li>
<li><a href="https://chrisrichardson.net/post/sagas/2019/08/04/developing-sagas-part-2.html">saga coordination mechanisms: choreography and orchestration</a></li>
<li><a href="https://chrisrichardson.net/post/sagas/2019/08/15/developing-sagas-part-3.html">implementing choreography-based sagas</a></li>
<li><a href="https://chrisrichardson.net/post/sagas/2019/12/12/developing-sagas-part-4.html">implementing orchestration-based sagas</a></li>
</ul>
</li>
<li>Saga와 비동기 마이크로서비스에 대한 <a href="https://microservices.io/presentations">발표들</a></li>
</ul>
<h2 id="example-code">Example code</h2>
<p>아래 예제는 Customer, Order 예제를 각각 다른 방식으로 구현한다.</p>
<ul>
<li><a href="https://github.com/eventuate-tram/eventuate-tram-core">Eventuate Tram framework</a>를 사용 한 <a href="https://github.com/eventuate-tram/eventuate-tram-examples-customers-and-orders">Choreography 기반 saga</a></li>
<li><a href="https://github.com/eventuate-tram/eventuate-tram-sagas">Eventuate Tram Sagas framework</a>를 사용 한 <a href="https://github.com/eventuate-tram/eventuate-tram-sagas-examples-customers-and-orders">Orchestration 기반 saga</a></li>
<li><a href="http://eventuate.io/">Eventuate event sourcing framework</a>를 사용 한 <a href="https://github.com/eventuate-examples/eventuate-examples-java-customers-and-orders">Choreography와 event sourcing 기반 saga</a></li>
</ul>
</div></article><footer><span>Github (<a href="https://github.com/juchanei">@juchanei</a>)</span></footer></main><script src="/_next/static/chunks/webpack-df73c3a7ea0771f4.js" async=""></script><script src="/_next/static/chunks/2443530c-82eff788789df68b.js" async=""></script><script src="/_next/static/chunks/139-0eb3f6144d0a8a28.js" async=""></script><script src="/_next/static/chunks/main-app-527630b440ad130e.js" async=""></script></body></html><script>(self.__next_f=self.__next_f||[]).push([0])</script><script>self.__next_f.push([1,"1:HL[\"/_next/static/css/d32bf43455ded298.css\",{\"as\":\"style\"}]\n0:\"$L2\"\n"])</script><script>self.__next_f.push([1,"3:HL[\"/_next/static/css/e175a87955b7f53c.css\",{\"as\":\"style\"}]\n"])</script><script>self.__next_f.push([1,"4:I{\"id\":\"7858\",\"chunks\":[\"272:static/chunks/webpack-df73c3a7ea0771f4.js\",\"667:static/chunks/2443530c-82eff788789df68b.js\",\"139:static/chunks/139-0eb3f6144d0a8a28.js\"],\"name\":\"\",\"async\":false}\n6:I{\"id\":\"3055\",\"chunks\":[\"272:static/chunks/webpack-df73c3a7ea0771f4.js\",\"667:static/chunks/2443530c-82eff788789df68b.js\",\"139:static/chunks/139-0eb3f6144d0a8a28.js\"],\"name\":\"\",\"async\":false}\n7:I{\"id\":\"7951\",\"chunks\":[\"414:static/chunks/414-1f2b980871695451.js\",\"185:static/chunks/app/layout-a1437d56a8d70c68.js\"],\"nam"])</script><script>self.__next_f.push([1,"e\":\"\",\"async\":false}\n8:I{\"id\":\"414\",\"chunks\":[\"414:static/chunks/414-1f2b980871695451.js\",\"222:static/chunks/app/articles/page-396ceb5d519c38af.js\"],\"name\":\"\",\"async\":false}\n9:I{\"id\":\"9544\",\"chunks\":[\"272:static/chunks/webpack-df73c3a7ea0771f4.js\",\"667:static/chunks/2443530c-82eff788789df68b.js\",\"139:static/chunks/139-0eb3f6144d0a8a28.js\"],\"name\":\"\",\"async\":false}\na:I{\"id\":\"99\",\"chunks\":[\"272:static/chunks/webpack-df73c3a7ea0771f4.js\",\"667:static/chunks/2443530c-82eff788789df68b.js\",\"139:static/chunks/139-0"])</script><script>self.__next_f.push([1,"eb3f6144d0a8a28.js\"],\"name\":\"\",\"async\":false}\nb:I{\"id\":\"8607\",\"chunks\":[\"943:static/chunks/943-e365b4e8cd375ef4.js\",\"83:static/chunks/app/articles/[slug]/page-4dc4cd3d17050a2d.js\"],\"name\":\"\",\"async\":false}\n"])</script><script>self.__next_f.push([1,"2:[[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/d32bf43455ded298.css\",\"precedence\":\"next\"}]],[\"$\",\"$L4\",null,{\"assetPrefix\":\"\",\"initialCanonicalUrl\":\"/articles/Sagas\",\"initialTree\":[\"\",{\"children\":[\"articles\",{\"children\":[[\"slug\",\"Sagas\",\"d\"],{\"children\":[\"__PAGE__?{\\\"slug\\\":\\\"Sagas\\\"}\",{}]}]}]},\"$undefined\",\"$undefined\",true],\"initialHead\":[\"$L5\",null],\"globalErrorComponent\":\"$6\",\"notFound\":[\"$\",\"html\",null,{\"lang\":\"ko\",\"children\":[[\"$\",\"head\",null,{\"children\":[[\"$\",\"title\",null,{\"children\":\"juchanei\"}],[\"$\",\"meta\",null,{\"name\":\"description\",\"content\":\"$undefined\"}],[\"$\",\"meta\",null,{\"property\":\"og:site_name\",\"content\":\"juchanei\"}],[\"$\",\"meta\",null,{\"property\":\"og:type\",\"content\":\"blog\"}],[\"$\",\"meta\",null,{\"property\":\"og:title\",\"content\":\"juchanei\"}],[\"$\",\"meta\",null,{\"property\":\"og:image\",\"content\":\"/logo_transparent.png\"}],[\"$\",\"meta\",null,{\"property\":\"og:url\",\"content\":\"https://juchanei.github.io\"}],[\"$\",\"meta\",null,{\"property\":\"og:description\",\"content\":\"$undefined\"}],[\"$\",\"meta\",null,{\"property\":\"og:locale\",\"content\":\"ko_KR\"}],[\"$\",\"meta\",null,{\"name\":\"twitter:card\",\"content\":\"summary\"}],[\"$\",\"meta\",null,{\"name\":\"twitter:title\",\"content\":\"juchanei\"}],[\"$\",\"meta\",null,{\"name\":\"twitter:description\",\"content\":\"$undefined\"}],[\"$\",\"meta\",null,{\"name\":\"twitter:image\",\"content\":\"/logo_transparent.png\"}],[\"$\",\"meta\",null,{\"name\":\"google-site-verification\",\"content\":\"zMe30NikxkVrHQc8KL1LeFDlYRx13BypWzaXpglLe3Q\"}],[\"$\",\"link\",null,{\"rel\":\"stylesheet\",\"href\":\"https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/atom-one-light.min.css\"}],[\"$\",\"link\",null,{\"rel\":\"stylesheet\",\"href\":\"https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/atom-one-dark.min.css\",\"media\":\"screen and (prefers-color-scheme: dark)\"}]]}],[\"$\",\"$L7\",null,{\"src\":\"https://www.googletagmanager.com/gtag/js?id=G-JRWY82TBQY\",\"strategy\":\"afterInteractive\"}],[\"$\",\"$L7\",null,{\"id\":\"google-analytics\",\"strategy\":\"afterInteractive\",\"children\":\"\\n                window.dataLayer = window.dataLayer || [];\\n                function gtag(){window.dataLayer.push(arguments);}\\n                gtag('js', new Date());\\n\\n                gtag('config', 'G-JRWY82TBQY');\\n                \"}],[\"$\",\"body\",null,{\"children\":[\"$\",\"main\",null,{\"className\":\"Layout_main__maYPe\",\"children\":[[\"$\",\"header\",null,{\"children\":[[\"$\",\"$L8\",null,{\"className\":\"Layout_logo__tEsDc\",\"href\":\"/\",\"children\":\"juchanei\"}],[\"$\",\"nav\",null,{\"children\":[\"$\",\"ul\",null,{\"children\":[[\"$\",\"li\",\"/about\",{\"children\":[\"$\",\"$L8\",null,{\"href\":\"/about\",\"target\":\"$undefined\",\"children\":\"about\"}]}],[\"$\",\"li\",\"/articles\",{\"children\":[\"$\",\"$L8\",null,{\"href\":\"/articles\",\"target\":\"$undefined\",\"children\":\"articles\"}]}],[\"$\",\"li\",\"https://github.com/juchanei\",{\"children\":[\"$\",\"$L8\",null,{\"href\":\"https://github.com/juchanei\",\"target\":\"blank\",\"children\":\"github\"}]}]]}]}]]}],[\"$\",\"article\",null,{\"children\":[\"$undefined\",[[\"$\",\"title\",null,{\"children\":\"404: This page could not be found.\"}],[\"$\",\"div\",null,{\"style\":{\"fontFamily\":\"system-ui,\\\"Segoe UI\\\",Roboto,Helvetica,Arial,sans-serif,\\\"Apple Color Emoji\\\",\\\"Segoe UI Emoji\\\"\",\"height\":\"100vh\",\"textAlign\":\"center\",\"display\":\"flex\",\"flexDirection\":\"column\",\"alignItems\":\"center\",\"justifyContent\":\"center\"},\"children\":[\"$\",\"div\",null,{\"children\":[[\"$\",\"style\",null,{\"dangerouslySetInnerHTML\":{\"__html\":\"body{color:#000;background:#fff;margin:0}.next-error-h1{border-right:1px solid rgba(0,0,0,.3)}@media (prefers-color-scheme:dark){body{color:#fff;background:#000}.next-error-h1{border-right:1px solid rgba(255,255,255,.3)}}\"}}],[\"$\",\"h1\",null,{\"className\":\"next-error-h1\",\"style\":{\"display\":\"inline-block\",\"margin\":\"0 20px 0 0\",\"padding\":\"0 23px 0 0\",\"fontSize\":24,\"fontWeight\":500,\"verticalAlign\":\"top\",\"lineHeight\":\"49px\"},\"children\":\"404\"}],[\"$\",\"div\",null,{\"style\":{\"display\":\"inline-block\"},\"children\":[\"$\",\"h2\",null,{\"style\":{\"fontSize\":14,\"fontWeight\":400,\"lineHeight\":\"49px\",\"margin\":0},\"children\":\"This page could not be found.\"}]}]]}]}]]]}],[\"$\",\"footer\",null,{\"children\":[\"$\",\"span\",null,{\"children\":[\"Github (\",[\"$\",\"a\",null,{\"href\":\"https://github.com/juchanei\",\"children\":\"@juchanei\"}],\")\"]}]}]]}]}]]}],\"asNotFound\":false,\"children\":[[\"$\",\"html\",null,{\"lang\":\"ko\",\"children\":[[\"$\",\"head\",null,{\"children\":[[\"$\",\"title\",null,{\"children\":\"juchanei\"}],[\"$\",\"meta\",null,{\"name\":\"description\",\"content\":\"$undefined\"}],[\"$\",\"meta\",null,{\"property\":\"og:site_name\",\"content\":\"juchanei\"}],[\"$\",\"meta\",null,{\"property\":\"og:type\",\"content\":\"blog\"}],[\"$\",\"meta\",null,{\"property\":\"og:title\",\"content\":\"juchanei\"}],[\"$\",\"meta\",null,{\"property\":\"og:image\",\"content\":\"/logo_transparent.png\"}],[\"$\",\"meta\",null,{\"property\":\"og:url\",\"content\":\"https://juchanei.github.io\"}],[\"$\",\"meta\",null,{\"property\":\"og:description\",\"content\":\"$undefined\"}],[\"$\",\"meta\",null,{\"property\":\"og:locale\",\"content\":\"ko_KR\"}],[\"$\",\"meta\",null,{\"name\":\"twitter:card\",\"content\":\"summary\"}],[\"$\",\"meta\",null,{\"name\":\"twitter:title\",\"content\":\"juchanei\"}],[\"$\",\"meta\",null,{\"name\":\"twitter:description\",\"content\":\"$undefined\"}],[\"$\",\"meta\",null,{\"name\":\"twitter:image\",\"content\":\"/logo_transparent.png\"}],[\"$\",\"meta\",null,{\"name\":\"google-site-verification\",\"content\":\"zMe30NikxkVrHQc8KL1LeFDlYRx13BypWzaXpglLe3Q\"}],[\"$\",\"link\",null,{\"rel\":\"stylesheet\",\"href\":\"https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/atom-one-light.min.css\"}],[\"$\",\"link\",null,{\"rel\":\"stylesheet\",\"href\":\"https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/atom-one-dark.min.css\",\"media\":\"screen and (prefers-color-scheme: dark)\"}]]}],[\"$\",\"$L7\",null,{\"src\":\"https://www.googletagmanager.com/gtag/js?id=G-JRWY82TBQY\",\"strategy\":\"afterInteractive\"}],[\"$\",\"$L7\",null,{\"id\":\"google-analytics\",\"strategy\":\"afterInteractive\",\"children\":\"\\n                window.dataLayer = window.dataLayer || [];\\n                function gtag(){window.dataLayer.push(arguments);}\\n                gtag('js', new Date());\\n\\n                gtag('config', 'G-JRWY82TBQY');\\n                \"}],[\"$\",\"body\",null,{\"children\":[\"$\",\"main\",null,{\"className\":\"Layout_main__maYPe\",\"children\":[[\"$\",\"header\",null,{\"children\":[[\"$\",\"$L8\",null,{\"className\":\"Layout_logo__tEsDc\",\"href\":\"/\",\"children\":\"juchanei\"}],[\"$\",\"nav\",null,{\"children\":[\"$\",\"ul\",null,{\"children\":[[\"$\",\"li\",\"/about\",{\"children\":[\"$\",\"$L8\",null,{\"href\":\"/about\",\"target\":\"$undefined\",\"children\":\"about\"}]}],[\"$\",\"li\",\"/articles\",{\"children\":[\"$\",\"$L8\",null,{\"href\":\"/articles\",\"target\":\"$undefined\",\"children\":\"articles\"}]}],[\"$\",\"li\",\"https://github.com/juchanei\",{\"children\":[\"$\",\"$L8\",null,{\"href\":\"https://github.com/juchanei\",\"target\":\"blank\",\"children\":\"github\"}]}]]}]}]]}],[\"$\",\"article\",null,{\"children\":[\"$\",\"$L9\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"loading\":\"$undefined\",\"loadingStyles\":\"$undefined\",\"hasLoading\":false,\"template\":[\"$\",\"$La\",null,{}],\"templateStyles\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\",\"asNotFound\":false,\"childProp\":{\"current\":[\"$\",\"$L9\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"articles\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"loading\":\"$undefined\",\"loadingStyles\":\"$undefined\",\"hasLoading\":false,\"template\":[\"$\",\"$La\",null,{}],\"templateStyles\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\",\"asNotFound\":false,\"childProp\":{\"current\":[\"$\",\"$L9\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"articles\",\"children\",[\"slug\",\"Sagas\",\"d\"],\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"loading\":\"$undefined\",\"loadingStyles\":\"$undefined\",\"hasLoading\":false,\"template\":[\"$\",\"$La\",null,{}],\"templateStyles\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\",\"asNotFound\":false,\"childProp\":{\"current\":[[\"$\",\"$Lb\",null,{\"title\":\"Sagas\",\"date\":\"$D2022-11-22T15:55:00.000Z\",\"tags\":[\"saga\",\"microservice\",\"transaction\",\"message\",\"event\"],\"html\":\"\u003cblockquote\u003e\\n\u003cp\u003e\u003ca href=\\\"https://microservices.io/patterns/data/saga.html\\\"\u003ehttps://microservices.io/patterns/data/saga.html\u003c/a\u003e 을 번역한 글입니다.\u003c/p\u003e\\n\u003c/blockquote\u003e\\n\u003ch2 id=\\\"context\\\"\u003eContext\u003c/h2\u003e\\n\u003cp\u003e당신은 \u003ca href=\\\"https://microservices.io/patterns/data/database-per-service.html\\\"\u003eDatabase per Service\u003c/a\u003e 패턴을 적용했다. 각각 의 서비스는 자신만의 데이터베이스를 가지고 있다. 그런데, 한 비즈니스 트랜잭션이 여러 서비스에 걸쳐 존재하고 당신은 이를 구현하기 위한 메커니즘이 필요하다. 예를 들어, 구매자에게 신용한도가 있는 e-커머스 스토어를 만든다고 해보자. Order 서비스와 Customer 서비스는 각각의 데이터베이스를 가지고 있어 로컬 ACID 트랜잭션을 쓸 수 없는 상태이다.\u003c/p\u003e\\n\u003ch2 id=\\\"problem\\\"\u003eProblem\u003c/h2\u003e\\n\u003cp\u003e어떻게 하면 여러 서비스에 걸쳐 트랜잭션을 구현할 수 있을까?\u003c/p\u003e\\n\u003ch2 id=\\\"forces\\\"\u003eForces\u003c/h2\u003e\\n\u003cul\u003e\\n\u003cli\u003e2PC (2 Phase Commit)은 사용하지 않는다.\u003c/li\u003e\\n\u003c/ul\u003e\\n\u003ch2 id=\\\"solution\\\"\u003eSolution\u003c/h2\u003e\\n\u003cp\u003e여러 서비스에 걸친 비즈니스 트랜잭션은 saga로 구현한다. Saga는 연속된 로컬 트랜잭션이다. 각각의 로컬 트랜잭션은 데이터베이스를 업데이트하고 메시지나 이벤트를 발행해 saga 다음 트랜잭션을 트리거한다. 만약 비즈니스 규칙을 위반하여 로컬 트랜잭션이 실패하면 saga는 이전 트랜잭션으로 인한 변화를 되돌리기 위해 보상 트랜잭션들을 실행한다.\u003c/p\u003e\\n\u003cp\u003e\u003cimg src=\\\"https://user-images.githubusercontent.com/10704195/203361071-e470cbd0-840e-4d89-b7aa-392a917c9c29.png\\\" alt=\\\"image\\\"\u003e\u003c/p\u003e\\n\u003cp\u003e여기에 saga를 조정(coordination)하는 두 방식이 있다.\u003c/p\u003e\\n\u003cul\u003e\\n\u003cli\u003eChoreography - 각각의 로컬 트랜잭션이 다른 서비스의 로컬 트랜잭션을 트리거 하는 도메인 이벤트를 발행한다.\u003c/li\u003e\\n\u003cli\u003eOrchestration - 오케스트레이터가 다른 서비스들에게 로컬 트랜잭션을 실행하도록 지시한다.\u003c/li\u003e\\n\u003c/ul\u003e\\n\u003ch2 id=\\\"example-choreography-based-saga\\\"\u003eExample: Choreography-based saga\u003c/h2\u003e\\n\u003cp\u003e\u003cimg src=\\\"https://user-images.githubusercontent.com/10704195/203361160-6d81af0f-c692-43e6-8f11-a53c29404164.png\\\" alt=\\\"image\\\"\u003e\u003c/p\u003e\\n\u003cp\u003ee-커머스 어플리케이션이 choreography 기반의 saga를 사용하여 ‘주문’을 생성하려고 한다면, 아래 단계를 따른다.\u003c/p\u003e\\n\u003col\u003e\\n\u003cli\u003e\u003ccode\u003eOrder\u003c/code\u003e 서비스는 \u003ccode\u003ePOST /orders\u003c/code\u003e 요청을 받고 \u003ccode\u003eOrder\u003c/code\u003e를 \u003ccode\u003ePENDING\u003c/code\u003e 상태로 생성한다.\u003c/li\u003e\\n\u003cli\u003e\u003ccode\u003eOrder Created\u003c/code\u003e 이벤트를 발행한다.\u003c/li\u003e\\n\u003cli\u003e\u003ccode\u003eCustomer\u003c/code\u003e 서비스의 이벤트 핸들러가 이를 받아 ‘신용’을 확보한다.\u003c/li\u003e\\n\u003cli\u003e위 결과를 의미하는 이벤트를 발행한다.\u003c/li\u003e\\n\u003cli\u003e\u003ccode\u003eOrder\u003c/code\u003e 서비스의 이벤트 핸들러가 \u003ccode\u003eOrder\u003c/code\u003e를 승인하거나 거절한다.\u003c/li\u003e\\n\u003c/ol\u003e\\n\u003ch2 id=\\\"example-orchestration-based-saga\\\"\u003eExample: Orchestration-based saga\u003c/h2\u003e\\n\u003cp\u003e\u003cimg src=\\\"https://user-images.githubusercontent.com/10704195/203361191-38660bcb-38c5-4de0-a6f7-4b1ac500c21f.png\\\" alt=\\\"image\\\"\u003e\u003c/p\u003e\\n\u003cp\u003ee-커머스 어플리케이션이 orchestration 기반의 saga를 사용하여 ‘주문’을 생성하려고 한다면, 아래 단계를 따른다.\u003c/p\u003e\\n\u003col\u003e\\n\u003cli\u003e\u003ccode\u003eOrder\u003c/code\u003e 서비스가 \u003ccode\u003ePOST /orders\u003c/code\u003e 요청을 받고 \u003ccode\u003eCreate Order\u003c/code\u003e saga 오케스트레이터를 생성한다.\u003c/li\u003e\\n\u003cli\u003esaga 오케스트레이터는 \u003ccode\u003eOrder\u003c/code\u003e를 \u003ccode\u003ePENDING\u003c/code\u003e 상태로 생성한다.\u003c/li\u003e\\n\u003cli\u003e그리고 \u003ccode\u003eReserve Credit\u003c/code\u003e 명령(command)를 \u003ccode\u003eCustomer\u003c/code\u003e 서비스로 보낸다.\u003c/li\u003e\\n\u003cli\u003e\u003ccode\u003eCustomer\u003c/code\u003e 서비스는 ‘신용’을 확보한다.\u003c/li\u003e\\n\u003cli\u003e\u003ccode\u003eCustomer\u003c/code\u003e 서비스는 결과를 saga 오케스트레이터에게 보낸다.\u003c/li\u003e\\n\u003cli\u003esaga 오케스트레이터는 \u003ccode\u003eOrder\u003c/code\u003e를 승인하거나 거절한다.\u003c/li\u003e\\n\u003c/ol\u003e\\n\u003ch2 id=\\\"resulting-context\\\"\u003eResulting context\u003c/h2\u003e\\n\u003cp\u003e이 패턴은 다음과 같은 장점이 있다.\u003c/p\u003e\\n\u003cul\u003e\\n\u003cli\u003e분산 트랜잭션 없이 여러 서비스에 걸쳐 데이터 일관성을 유지할 수 있도록 한다.\u003c/li\u003e\\n\u003c/ul\u003e\\n\u003cp\u003e이  패턴은 다음과 같은 단점이 있다.\u003c/p\u003e\\n\u003cul\u003e\\n\u003cli\u003e프로그래밍 모델이 복잡하다. 예를 들어, 개발자는 앞선 변화를 되돌릴 수 있도록 반드시 보상 트랜잭션을 설계해야 한다.\u003c/li\u003e\\n\u003c/ul\u003e\\n\u003cp\u003e이 패턴은 또한 아래 대처해야 할 이슈가 있다.\u003c/p\u003e\\n\u003cul\u003e\\n\u003cli\u003e신뢰성을 위해 서비스는 반드시 원자적으로 데이터베이스를 업데이트 한 후 메시지/이벤트를 발행해야 한다. 이때 데이터베이스와 메시지 브로커에 걸친 분산 트랜잭션 메커니즘은 사용할 수 없다. 대신, 다음에 소개 될 아래 패턴 중 하나를 사용해야 한다.\u003c/li\u003e\\n\u003cli\u003e클라이언트는 동기적인 요청(e.g. HTTP \u003ccode\u003ePOST /orders\u003c/code\u003e)을 통해 saga를 동작 시키고, 그 결과를 비동기적으로 얻어야 한다. 여기에는 트레이드오프가 있는 몇가지 옵션이 있다.\u003cul\u003e\\n\u003cli\u003e서비스는 saga가 완료되면 그 결과를 응답한다. (e.g. \u003ccode\u003eOrderApproved\u003c/code\u003e 또는 \u003ccode\u003eOrderRejected\u003c/code\u003e 이벤트)\u003c/li\u003e\\n\u003cli\u003e서비스는 saga를 동작시킨 뒤 \u003ccode\u003eorderID\u003c/code\u003e를 포함하여 응답한다. 클라이언트는 주기적으로 \u003ccode\u003eGET /orders/{orderID}\u003c/code\u003e를 요청해 polling 하여 결과를 얻는다.\u003c/li\u003e\\n\u003cli\u003e서비스는 saga를 동작시킨 뒤 \u003ccode\u003eorderID\u003c/code\u003e를 포함하여 응답한다. 그리고 saga가 완료되면 웹 소캣 또는 웹 훅 등을 이용해 이벤트를 발행한다.\u003c/li\u003e\\n\u003c/ul\u003e\\n\u003c/li\u003e\\n\u003c/ul\u003e\\n\u003ch2 id=\\\"related-patterns\\\"\u003eRelated patterns\u003c/h2\u003e\\n\u003cul\u003e\\n\u003cli\u003e이 패턴은 \u003ca href=\\\"https://microservices.io/patterns/data/database-per-service.html\\\"\u003eDatabase per Service pattern\u003c/a\u003e의 필요로 인해 고안됐다.\u003c/li\u003e\\n\u003cli\u003e아래 패턴 들은 \u003cem\u003e원자적으로\u003c/em\u003e  업데이트와 메시지/이벤트를 발행하는 방법이다.\u003cul\u003e\\n\u003cli\u003e\u003ca href=\\\"https://microservices.io/patterns/data/event-sourcing.html\\\"\u003eEvent sourcing\u003c/a\u003e\u003c/li\u003e\\n\u003cli\u003e\u003ca href=\\\"https://microservices.io/patterns/data/transactional-outbox.html\\\"\u003eTransactional Outbox\u003c/a\u003e\u003c/li\u003e\\n\u003c/ul\u003e\\n\u003c/li\u003e\\n\u003cli\u003eChoreography 기반 saga는 \u003ca href=\\\"https://microservices.io/patterns/data/aggregate.html\\\"\u003eAggregates\u003c/a\u003e와 \u003ca href=\\\"https://microservices.io/patterns/data/domain-event.html\\\"\u003eDomain Events\u003c/a\u003e를 사용해 이벤트를 발행한다.\u003c/li\u003e\\n\u003c/ul\u003e\\n\u003ch2 id=\\\"learn-more\\\"\u003eLearn more\u003c/h2\u003e\\n\u003cul\u003e\\n\u003cli\u003e책 \u003ca href=\\\"https://microservices.io/book\\\"\u003eMicroservices patterns\u003c/a\u003e는 이 패턴에 대해 상세히 설명한다. 이 책의 \u003ca href=\\\"https://github.com/microservice-patterns/ftgo-application\\\"\u003eexample application\u003c/a\u003e은 \u003ca href=\\\"https://github.com/eventuate-tram/eventuate-tram-sagas\\\"\u003eEventuate Tram Sagas framework\u003c/a\u003e를 사용한 orchestration 기반의 saga로 구현되어있다.\u003c/li\u003e\\n\u003cli\u003e\u003ca href=\\\"https://chrisrichardson.net/virtual-bootcamp-distributed-data-management.html\\\"\u003eself-paced, online bootcamp\u003c/a\u003e에서 여러 서비스에 걸쳐 saga를 사용하는 방법, API Composition, CQRS 패턴을 배울 수 있다.\u003c/li\u003e\\n\u003cli\u003eSaga 패턴에 관한 블로그 포스트\u003cul\u003e\\n\u003cli\u003e\u003ca href=\\\"https://chrisrichardson.net/post/antipatterns/2019/07/09/developing-sagas-part-1.html\\\"\u003eoverview of sagas\u003c/a\u003e\u003c/li\u003e\\n\u003cli\u003e\u003ca href=\\\"https://chrisrichardson.net/post/sagas/2019/08/04/developing-sagas-part-2.html\\\"\u003esaga coordination mechanisms: choreography and orchestration\u003c/a\u003e\u003c/li\u003e\\n\u003cli\u003e\u003ca href=\\\"https://chrisrichardson.net/post/sagas/2019/08/15/developing-sagas-part-3.html\\\"\u003eimplementing choreography-based sagas\u003c/a\u003e\u003c/li\u003e\\n\u003cli\u003e\u003ca href=\\\"https://chrisrichardson.net/post/sagas/2019/12/12/developing-sagas-part-4.html\\\"\u003eimplementing orchestration-based sagas\u003c/a\u003e\u003c/li\u003e\\n\u003c/ul\u003e\\n\u003c/li\u003e\\n\u003cli\u003eSaga와 비동기 마이크로서비스에 대한 \u003ca href=\\\"https://microservices.io/presentations\\\"\u003e발표들\u003c/a\u003e\u003c/li\u003e\\n\u003c/ul\u003e\\n\u003ch2 id=\\\"example-code\\\"\u003eExample code\u003c/h2\u003e\\n\u003cp\u003e아래 예제는 Customer, Order 예제를 각각 다른 방식으로 구현한다.\u003c/p\u003e\\n\u003cul\u003e\\n\u003cli\u003e\u003ca href=\\\"https://github.com/eventuate-tram/eventuate-tram-core\\\"\u003eEventuate Tram framework\u003c/a\u003e를 사용 한 \u003ca href=\\\"https://github.com/eventuate-tram/eventuate-tram-examples-customers-and-orders\\\"\u003eChoreography 기반 saga\u003c/a\u003e\u003c/li\u003e\\n\u003cli\u003e\u003ca href=\\\"https://github.com/eventuate-tram/eventuate-tram-sagas\\\"\u003eEventuate Tram Sagas framework\u003c/a\u003e를 사용 한 \u003ca href=\\\"https://github.com/eventuate-tram/eventuate-tram-sagas-examples-customers-and-orders\\\"\u003eOrchestration 기반 saga\u003c/a\u003e\u003c/li\u003e\\n\u003cli\u003e\u003ca href=\\\"http://eventuate.io/\\\"\u003eEventuate event sourcing framework\u003c/a\u003e를 사용 한 \u003ca href=\\\"https://github.com/eventuate-examples/eventuate-examples-java-customers-and-orders\\\"\u003eChoreography와 event sourcing 기반 saga\u003c/a\u003e\u003c/li\u003e\\n\u003c/ul\u003e\\n\"}],null],\"segment\":\"__PAGE__?{\\\"slug\\\":\\\"Sagas\\\"}\"},\"styles\":[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/e175a87955b7f53c.css\",\"precedence\":\"next\"}]]}],\"segment\":[\"slug\",\"Sagas\",\"d\"]},\"styles\":[]}],\"segment\":\"articles\"},\"styles\":[]}]}],[\"$\",\"footer\",null,{\"children\":[\"$\",\"span\",null,{\"children\":[\"Github (\",[\"$\",\"a\",null,{\"href\":\"https://github.com/juchanei\",\"children\":\"@juchanei\"}],\")\"]}]}]]}]}]]}],null]}]]\n"])</script><script>self.__next_f.push([1,"5:[[[\"$\",\"meta\",null,{\"charSet\":\"utf-8\"}],null,null,null,null,null,null,null,null,null,null,[\"$\",\"meta\",null,{\"name\":\"viewport\",\"content\":\"width=device-width, initial-scale=1\"}],null,null,null,null,null,null,null,null,null,null,[]],[null,null,null,null],null,null,[null,null,null,null,null],null,null,null,null,null]\n"])</script>
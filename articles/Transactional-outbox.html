<!DOCTYPE html><html lang="ko"><head><meta charSet="utf-8"/><link rel="stylesheet" href="/_next/static/css/d32bf43455ded298.css" data-precedence="next"/><link rel="stylesheet" href="/_next/static/css/e175a87955b7f53c.css" data-precedence="next"/><link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/atom-one-light.min.css"/><link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/atom-one-dark.min.css" media="screen and (prefers-color-scheme: dark)"/><link rel="preload" as="script" href="https://www.googletagmanager.com/gtag/js?id=G-JRWY82TBQY"/><title>juchanei</title><meta name="description"/><meta property="og:site_name" content="juchanei"/><meta property="og:type" content="blog"/><meta property="og:title" content="juchanei"/><meta property="og:image" content="/logo_transparent.png"/><meta property="og:url" content="https://juchanei.github.io"/><meta property="og:description"/><meta property="og:locale" content="ko_KR"/><meta name="twitter:card" content="summary"/><meta name="twitter:title" content="juchanei"/><meta name="twitter:description"/><meta name="twitter:image" content="/logo_transparent.png"/><meta name="google-site-verification" content="zMe30NikxkVrHQc8KL1LeFDlYRx13BypWzaXpglLe3Q"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/atom-one-light.min.css"/><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/atom-one-dark.min.css" media="screen and (prefers-color-scheme: dark)"/><script src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js" noModule=""></script></head><body><main class="Layout_main__maYPe"><header><a class="Layout_logo__tEsDc" href="/">juchanei</a><nav><ul><li><a href="/about">about</a></li><li><a href="/articles">articles</a></li><li><a target="blank" href="https://github.com/juchanei">github</a></li></ul></nav></header><article><h1>Transactional outbox</h1><time>November 15, 2022</time><hr class="Article_bar__LgwyR"/><div class="Article_blog-post-content__vjQ_B"><blockquote>
<p><a href="https://microservices.io/patterns/data/transactional-outbox.html">https://microservices.io/patterns/data/transactional-outbox.html</a>을 번역한 글입니다.</p>
</blockquote>
<h2 id="also-known-as">Also known as</h2>
<p>Application events</p>
<h2 id="context">Context</h2>
<p>전형적인 서비스 커맨드는 데이터베이스를 업데이트 하는 동시에 메시지/이벤트를 발송할 필요가 있다. 예를 들면, <a href="https://microservices.io/patterns/data/saga.html">saga</a>에 참여하는 서비스는 데이터베이스 업데이트와 메시지/이벤트 발행을 원자적으로 수행해야 한다. <a href="https://microservices.io/patterns/data/domain-event.html">도메인 이벤트</a>(domain event)를 발행하는 서비스 역시 <a href="https://microservices.io/patterns/data/aggregate.html">aggregate</a>을 업데이트하고 이벤트를 발행하는 동작을 원자적으로 수행해야 한다.</p>
<p>서비스 커맨드는 일반적으로 데이터베이스를 업데이트하는 <strong>동시에</strong> 메시지/이벤트를 발송한다. 그러나 메시지 브로커는 보통 전통적인 분산 트랜잭션(Two phase commit, 2PC)를 지원하지 않기 때문에, 데이터베이스와 메시지 브로커에 걸쳐 업데이트와 메시지/이벤트 발행을 원자적으로 수행할 수 없다. 만약 가능하다 하더라도 서비스가 데이터베이스와 메시지에 모두 결합되는 구조는 바람직 하지 않을 수 있다.</p>
<p>하지만 2PC를 사용하지 않으면, 트랜잭션 중에 메시지가 발송된 것을 확신할 수 없다. 트랜잭션이 커밋 되는 것을 보장할 수 없을 뿐만 아니라, 트랜잭션 커밋 후 메시지 발송 중에 크래시가 발생하지 않는다는 것 또한 보장할 수 없다.</p>
<p>더불어, 메시지는 반드시 서비스가 발송한 순서대로 메시지 브로커에 도착해야 한다. 예를 들면, 서비스에서 한 aggregate이 트랜잭션 <code>T1</code>, <code>T2</code>에 의해 업데이트 된다고 하자. 두 트랜잭션은  같은 서비스 인스턴스에서 수행될 수도 있고 다른 서비스 인스턴스에서 수행될 수도 있다. 각각 트랜잭션은 대응되는 이벤트 <code>E1</code>, <code>E2</code>가 있다. 이 때 만일 트랜잭션 <code>T1</code> 다음에 <code>T2</code>가 수행된다면, 이벤트 <code>E2</code>는 반드시 <code>E1</code> 다음에 발행되어야 한다.</p>
<h2 id="problem">Problem</h2>
<p>어떻게 데이터베이스 업데이트와 메시지/이벤트 발행을 안정적/원자적으로 할 수 있을까?</p>
<h2 id="forces">Forces</h2>
<ul>
<li>2PC는 사용하지 않는다.</li>
<li>만약 데이터베이스 트랜잭션이 커밋됐다면, 메시지는 반드시 발송되어야 한다. 반대로 데이터베이스가 롤백되었다면, 메시지는 발송되지 않아야 한다.</li>
<li>메시지는 반드시 서비스가 발송한 순서대로 메시지 브로커에 도착해야 한다. 같은 aggregate을 업데이트하는 다수에 서비스 인스턴스에 걸쳐서 이 순서는 반드시 지켜져야 한다.</li>
</ul>
<h2 id="solution">Solution</h2>
<p>관계형 데이터베이스를 사용하는 서비스는 <em>outbox</em> 테이블(e.g. <code>MESSAGE</code>)에 메시지/이벤트를 로컬 트랜잭션으로 insert 한다. NoSQL 데이터베이스를 사용하는 서비스는 메시지/이벤트를 record(e.g. document 또는 item) attribute를 추가하는 방식으로 업데이트 한다. 별도의 <em>메시지 릴레이</em> 프로세스는 데이터베이스에 추가 된 이벤트를 메시지 브로커로 발행한다.</p>
<p><img src="https://user-images.githubusercontent.com/10704195/201923714-be54b86b-605c-417b-82d1-9a3149289c36.png" alt="image"></p>
<h2 id="result-context">Result context</h2>
<p>이 패턴은 아래와 같은 장점이 있다.</p>
<ul>
<li>2PC를 사용하지 않는다.</li>
<li>데이터베이스 트랜잭션이 커밋된 경우에만 메시지가 발송 되는 것을 보장 한다.</li>
<li>메시지는 어플리캐이션에 의해 발송된 순서대로 메시지 브로커에 도착한다.</li>
</ul>
<p>이 패턴은 아래와 같은 단점이 있다.</p>
<ul>
<li>개발자가 데이터베이스 업데이트 후에 메시지/이벤트를 발행하는 것을 잊어버릴 수 있기 때문에 잠재적으로 에러가 발생할 수 있다.</li>
</ul>
<p>이 패턴은 또한 아래 이슈가 있다.</p>
<ul>
<li>메시지 릴레이는 같은 메시지를 중복해서 발행할 수 있다. 예를 들면, 메시지를 발행한 후 발행 여부를 기록하기 전에 크래시가 일어나, 이를 재실행 하면서 메시지를 다시 발행할 수 있다. 따라서, 메시지 컨슈머는 이미 처리한 동일한 메시지에 대해서 반드시 멱등하게 동작해야 한다. 다행히도 메시지 컨슈머는 보통 멱등하게 동작하므로 (브로커는 메시지를 여러번 보낼 수 있다) 이 것이 문제되지 않는다.</li>
</ul>
<h2 id="related-patterns">Related patterns</h2>
<ul>
<li><a href="https://microservices.io/patterns/data/saga.html">Saga</a>와 <a href="https://microservices.io/patterns/data/domain-event.html">Domain event</a> 패턴에 이 패턴이 사용된다.</li>
<li><a href="https://microservices.io/patterns/data/event-sourcing.html">Event sourcing</a>은 이 솔루션의 다른 대안이다.</li>
<li><em>메시지 릴레이</em>를 구현하는데 아래 두 패턴이 사용된다.<ul>
<li><a href="https://microservices.io/patterns/data/transaction-log-tailing.html">Transaction log tailing</a> 패턴</li>
<li><a href="https://microservices.io/patterns/data/polling-publisher.html">Polling publisher</a> 패턴</li>
</ul>
</li>
</ul>
<h2 id="learn-more">Learn more</h2>
<ul>
<li>책 ‘<a href="https://microservices.io/book">Microservices patterns</a>’에 더 자세한 설명이 있다.</li>
<li><a href="https://github.com/eventuate-tram/eventuate-tram-core">Eventuate Tram framework</a>는 이 패턴의 구현체이다.</li>
</ul>
</div></article><footer><span>Github (<a href="https://github.com/juchanei">@juchanei</a>)</span></footer></main><script src="/_next/static/chunks/webpack-df73c3a7ea0771f4.js" async=""></script><script src="/_next/static/chunks/2443530c-82eff788789df68b.js" async=""></script><script src="/_next/static/chunks/139-0eb3f6144d0a8a28.js" async=""></script><script src="/_next/static/chunks/main-app-527630b440ad130e.js" async=""></script></body></html><script>(self.__next_f=self.__next_f||[]).push([0])</script><script>self.__next_f.push([1,"1:HL[\"/_next/static/css/d32bf43455ded298.css\",{\"as\":\"style\"}]\n0:\"$L2\"\n"])</script><script>self.__next_f.push([1,"3:HL[\"/_next/static/css/e175a87955b7f53c.css\",{\"as\":\"style\"}]\n"])</script><script>self.__next_f.push([1,"4:I{\"id\":\"7858\",\"chunks\":[\"272:static/chunks/webpack-df73c3a7ea0771f4.js\",\"667:static/chunks/2443530c-82eff788789df68b.js\",\"139:static/chunks/139-0eb3f6144d0a8a28.js\"],\"name\":\"\",\"async\":false}\n6:I{\"id\":\"3055\",\"chunks\":[\"272:static/chunks/webpack-df73c3a7ea0771f4.js\",\"667:static/chunks/2443530c-82eff788789df68b.js\",\"139:static/chunks/139-0eb3f6144d0a8a28.js\"],\"name\":\"\",\"async\":false}\n7:I{\"id\":\"7951\",\"chunks\":[\"414:static/chunks/414-1f2b980871695451.js\",\"185:static/chunks/app/layout-a1437d56a8d70c68.js\"],\"nam"])</script><script>self.__next_f.push([1,"e\":\"\",\"async\":false}\n8:I{\"id\":\"414\",\"chunks\":[\"414:static/chunks/414-1f2b980871695451.js\",\"222:static/chunks/app/articles/page-396ceb5d519c38af.js\"],\"name\":\"\",\"async\":false}\n9:I{\"id\":\"9544\",\"chunks\":[\"272:static/chunks/webpack-df73c3a7ea0771f4.js\",\"667:static/chunks/2443530c-82eff788789df68b.js\",\"139:static/chunks/139-0eb3f6144d0a8a28.js\"],\"name\":\"\",\"async\":false}\na:I{\"id\":\"99\",\"chunks\":[\"272:static/chunks/webpack-df73c3a7ea0771f4.js\",\"667:static/chunks/2443530c-82eff788789df68b.js\",\"139:static/chunks/139-0"])</script><script>self.__next_f.push([1,"eb3f6144d0a8a28.js\"],\"name\":\"\",\"async\":false}\nb:I{\"id\":\"8607\",\"chunks\":[\"943:static/chunks/943-e365b4e8cd375ef4.js\",\"83:static/chunks/app/articles/[slug]/page-4dc4cd3d17050a2d.js\"],\"name\":\"\",\"async\":false}\n"])</script><script>self.__next_f.push([1,"2:[[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/d32bf43455ded298.css\",\"precedence\":\"next\"}]],[\"$\",\"$L4\",null,{\"assetPrefix\":\"\",\"initialCanonicalUrl\":\"/articles/Transactional-outbox\",\"initialTree\":[\"\",{\"children\":[\"articles\",{\"children\":[[\"slug\",\"Transactional-outbox\",\"d\"],{\"children\":[\"__PAGE__?{\\\"slug\\\":\\\"Transactional-outbox\\\"}\",{}]}]}]},\"$undefined\",\"$undefined\",true],\"initialHead\":[\"$L5\",null],\"globalErrorComponent\":\"$6\",\"notFound\":[\"$\",\"html\",null,{\"lang\":\"ko\",\"children\":[[\"$\",\"head\",null,{\"children\":[[\"$\",\"title\",null,{\"children\":\"juchanei\"}],[\"$\",\"meta\",null,{\"name\":\"description\",\"content\":\"$undefined\"}],[\"$\",\"meta\",null,{\"property\":\"og:site_name\",\"content\":\"juchanei\"}],[\"$\",\"meta\",null,{\"property\":\"og:type\",\"content\":\"blog\"}],[\"$\",\"meta\",null,{\"property\":\"og:title\",\"content\":\"juchanei\"}],[\"$\",\"meta\",null,{\"property\":\"og:image\",\"content\":\"/logo_transparent.png\"}],[\"$\",\"meta\",null,{\"property\":\"og:url\",\"content\":\"https://juchanei.github.io\"}],[\"$\",\"meta\",null,{\"property\":\"og:description\",\"content\":\"$undefined\"}],[\"$\",\"meta\",null,{\"property\":\"og:locale\",\"content\":\"ko_KR\"}],[\"$\",\"meta\",null,{\"name\":\"twitter:card\",\"content\":\"summary\"}],[\"$\",\"meta\",null,{\"name\":\"twitter:title\",\"content\":\"juchanei\"}],[\"$\",\"meta\",null,{\"name\":\"twitter:description\",\"content\":\"$undefined\"}],[\"$\",\"meta\",null,{\"name\":\"twitter:image\",\"content\":\"/logo_transparent.png\"}],[\"$\",\"meta\",null,{\"name\":\"google-site-verification\",\"content\":\"zMe30NikxkVrHQc8KL1LeFDlYRx13BypWzaXpglLe3Q\"}],[\"$\",\"link\",null,{\"rel\":\"stylesheet\",\"href\":\"https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/atom-one-light.min.css\"}],[\"$\",\"link\",null,{\"rel\":\"stylesheet\",\"href\":\"https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/atom-one-dark.min.css\",\"media\":\"screen and (prefers-color-scheme: dark)\"}]]}],[\"$\",\"$L7\",null,{\"src\":\"https://www.googletagmanager.com/gtag/js?id=G-JRWY82TBQY\",\"strategy\":\"afterInteractive\"}],[\"$\",\"$L7\",null,{\"id\":\"google-analytics\",\"strategy\":\"afterInteractive\",\"children\":\"\\n                window.dataLayer = window.dataLayer || [];\\n                function gtag(){window.dataLayer.push(arguments);}\\n                gtag('js', new Date());\\n\\n                gtag('config', 'G-JRWY82TBQY');\\n                \"}],[\"$\",\"body\",null,{\"children\":[\"$\",\"main\",null,{\"className\":\"Layout_main__maYPe\",\"children\":[[\"$\",\"header\",null,{\"children\":[[\"$\",\"$L8\",null,{\"className\":\"Layout_logo__tEsDc\",\"href\":\"/\",\"children\":\"juchanei\"}],[\"$\",\"nav\",null,{\"children\":[\"$\",\"ul\",null,{\"children\":[[\"$\",\"li\",\"/about\",{\"children\":[\"$\",\"$L8\",null,{\"href\":\"/about\",\"target\":\"$undefined\",\"children\":\"about\"}]}],[\"$\",\"li\",\"/articles\",{\"children\":[\"$\",\"$L8\",null,{\"href\":\"/articles\",\"target\":\"$undefined\",\"children\":\"articles\"}]}],[\"$\",\"li\",\"https://github.com/juchanei\",{\"children\":[\"$\",\"$L8\",null,{\"href\":\"https://github.com/juchanei\",\"target\":\"blank\",\"children\":\"github\"}]}]]}]}]]}],[\"$\",\"article\",null,{\"children\":[\"$undefined\",[[\"$\",\"title\",null,{\"children\":\"404: This page could not be found.\"}],[\"$\",\"div\",null,{\"style\":{\"fontFamily\":\"system-ui,\\\"Segoe UI\\\",Roboto,Helvetica,Arial,sans-serif,\\\"Apple Color Emoji\\\",\\\"Segoe UI Emoji\\\"\",\"height\":\"100vh\",\"textAlign\":\"center\",\"display\":\"flex\",\"flexDirection\":\"column\",\"alignItems\":\"center\",\"justifyContent\":\"center\"},\"children\":[\"$\",\"div\",null,{\"children\":[[\"$\",\"style\",null,{\"dangerouslySetInnerHTML\":{\"__html\":\"body{color:#000;background:#fff;margin:0}.next-error-h1{border-right:1px solid rgba(0,0,0,.3)}@media (prefers-color-scheme:dark){body{color:#fff;background:#000}.next-error-h1{border-right:1px solid rgba(255,255,255,.3)}}\"}}],[\"$\",\"h1\",null,{\"className\":\"next-error-h1\",\"style\":{\"display\":\"inline-block\",\"margin\":\"0 20px 0 0\",\"padding\":\"0 23px 0 0\",\"fontSize\":24,\"fontWeight\":500,\"verticalAlign\":\"top\",\"lineHeight\":\"49px\"},\"children\":\"404\"}],[\"$\",\"div\",null,{\"style\":{\"display\":\"inline-block\"},\"children\":[\"$\",\"h2\",null,{\"style\":{\"fontSize\":14,\"fontWeight\":400,\"lineHeight\":\"49px\",\"margin\":0},\"children\":\"This page could not be found.\"}]}]]}]}]]]}],[\"$\",\"footer\",null,{\"children\":[\"$\",\"span\",null,{\"children\":[\"Github (\",[\"$\",\"a\",null,{\"href\":\"https://github.com/juchanei\",\"children\":\"@juchanei\"}],\")\"]}]}]]}]}]]}],\"asNotFound\":false,\"children\":[[\"$\",\"html\",null,{\"lang\":\"ko\",\"children\":[[\"$\",\"head\",null,{\"children\":[[\"$\",\"title\",null,{\"children\":\"juchanei\"}],[\"$\",\"meta\",null,{\"name\":\"description\",\"content\":\"$undefined\"}],[\"$\",\"meta\",null,{\"property\":\"og:site_name\",\"content\":\"juchanei\"}],[\"$\",\"meta\",null,{\"property\":\"og:type\",\"content\":\"blog\"}],[\"$\",\"meta\",null,{\"property\":\"og:title\",\"content\":\"juchanei\"}],[\"$\",\"meta\",null,{\"property\":\"og:image\",\"content\":\"/logo_transparent.png\"}],[\"$\",\"meta\",null,{\"property\":\"og:url\",\"content\":\"https://juchanei.github.io\"}],[\"$\",\"meta\",null,{\"property\":\"og:description\",\"content\":\"$undefined\"}],[\"$\",\"meta\",null,{\"property\":\"og:locale\",\"content\":\"ko_KR\"}],[\"$\",\"meta\",null,{\"name\":\"twitter:card\",\"content\":\"summary\"}],[\"$\",\"meta\",null,{\"name\":\"twitter:title\",\"content\":\"juchanei\"}],[\"$\",\"meta\",null,{\"name\":\"twitter:description\",\"content\":\"$undefined\"}],[\"$\",\"meta\",null,{\"name\":\"twitter:image\",\"content\":\"/logo_transparent.png\"}],[\"$\",\"meta\",null,{\"name\":\"google-site-verification\",\"content\":\"zMe30NikxkVrHQc8KL1LeFDlYRx13BypWzaXpglLe3Q\"}],[\"$\",\"link\",null,{\"rel\":\"stylesheet\",\"href\":\"https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/atom-one-light.min.css\"}],[\"$\",\"link\",null,{\"rel\":\"stylesheet\",\"href\":\"https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/atom-one-dark.min.css\",\"media\":\"screen and (prefers-color-scheme: dark)\"}]]}],[\"$\",\"$L7\",null,{\"src\":\"https://www.googletagmanager.com/gtag/js?id=G-JRWY82TBQY\",\"strategy\":\"afterInteractive\"}],[\"$\",\"$L7\",null,{\"id\":\"google-analytics\",\"strategy\":\"afterInteractive\",\"children\":\"\\n                window.dataLayer = window.dataLayer || [];\\n                function gtag(){window.dataLayer.push(arguments);}\\n                gtag('js', new Date());\\n\\n                gtag('config', 'G-JRWY82TBQY');\\n                \"}],[\"$\",\"body\",null,{\"children\":[\"$\",\"main\",null,{\"className\":\"Layout_main__maYPe\",\"children\":[[\"$\",\"header\",null,{\"children\":[[\"$\",\"$L8\",null,{\"className\":\"Layout_logo__tEsDc\",\"href\":\"/\",\"children\":\"juchanei\"}],[\"$\",\"nav\",null,{\"children\":[\"$\",\"ul\",null,{\"children\":[[\"$\",\"li\",\"/about\",{\"children\":[\"$\",\"$L8\",null,{\"href\":\"/about\",\"target\":\"$undefined\",\"children\":\"about\"}]}],[\"$\",\"li\",\"/articles\",{\"children\":[\"$\",\"$L8\",null,{\"href\":\"/articles\",\"target\":\"$undefined\",\"children\":\"articles\"}]}],[\"$\",\"li\",\"https://github.com/juchanei\",{\"children\":[\"$\",\"$L8\",null,{\"href\":\"https://github.com/juchanei\",\"target\":\"blank\",\"children\":\"github\"}]}]]}]}]]}],[\"$\",\"article\",null,{\"children\":[\"$\",\"$L9\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"loading\":\"$undefined\",\"loadingStyles\":\"$undefined\",\"hasLoading\":false,\"template\":[\"$\",\"$La\",null,{}],\"templateStyles\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\",\"asNotFound\":false,\"childProp\":{\"current\":[\"$\",\"$L9\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"articles\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"loading\":\"$undefined\",\"loadingStyles\":\"$undefined\",\"hasLoading\":false,\"template\":[\"$\",\"$La\",null,{}],\"templateStyles\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\",\"asNotFound\":false,\"childProp\":{\"current\":[\"$\",\"$L9\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"articles\",\"children\",[\"slug\",\"Transactional-outbox\",\"d\"],\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"loading\":\"$undefined\",\"loadingStyles\":\"$undefined\",\"hasLoading\":false,\"template\":[\"$\",\"$La\",null,{}],\"templateStyles\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\",\"asNotFound\":false,\"childProp\":{\"current\":[[\"$\",\"$Lb\",null,{\"title\":\"Transactional outbox\",\"date\":\"$D2022-11-15T12:51:00.000Z\",\"tags\":[\"microservice\",\"transaction\",\"message\",\"event\"],\"html\":\"\u003cblockquote\u003e\\n\u003cp\u003e\u003ca href=\\\"https://microservices.io/patterns/data/transactional-outbox.html\\\"\u003ehttps://microservices.io/patterns/data/transactional-outbox.html\u003c/a\u003e을 번역한 글입니다.\u003c/p\u003e\\n\u003c/blockquote\u003e\\n\u003ch2 id=\\\"also-known-as\\\"\u003eAlso known as\u003c/h2\u003e\\n\u003cp\u003eApplication events\u003c/p\u003e\\n\u003ch2 id=\\\"context\\\"\u003eContext\u003c/h2\u003e\\n\u003cp\u003e전형적인 서비스 커맨드는 데이터베이스를 업데이트 하는 동시에 메시지/이벤트를 발송할 필요가 있다. 예를 들면, \u003ca href=\\\"https://microservices.io/patterns/data/saga.html\\\"\u003esaga\u003c/a\u003e에 참여하는 서비스는 데이터베이스 업데이트와 메시지/이벤트 발행을 원자적으로 수행해야 한다. \u003ca href=\\\"https://microservices.io/patterns/data/domain-event.html\\\"\u003e도메인 이벤트\u003c/a\u003e(domain event)를 발행하는 서비스 역시 \u003ca href=\\\"https://microservices.io/patterns/data/aggregate.html\\\"\u003eaggregate\u003c/a\u003e을 업데이트하고 이벤트를 발행하는 동작을 원자적으로 수행해야 한다.\u003c/p\u003e\\n\u003cp\u003e서비스 커맨드는 일반적으로 데이터베이스를 업데이트하는 \u003cstrong\u003e동시에\u003c/strong\u003e 메시지/이벤트를 발송한다. 그러나 메시지 브로커는 보통 전통적인 분산 트랜잭션(Two phase commit, 2PC)를 지원하지 않기 때문에, 데이터베이스와 메시지 브로커에 걸쳐 업데이트와 메시지/이벤트 발행을 원자적으로 수행할 수 없다. 만약 가능하다 하더라도 서비스가 데이터베이스와 메시지에 모두 결합되는 구조는 바람직 하지 않을 수 있다.\u003c/p\u003e\\n\u003cp\u003e하지만 2PC를 사용하지 않으면, 트랜잭션 중에 메시지가 발송된 것을 확신할 수 없다. 트랜잭션이 커밋 되는 것을 보장할 수 없을 뿐만 아니라, 트랜잭션 커밋 후 메시지 발송 중에 크래시가 발생하지 않는다는 것 또한 보장할 수 없다.\u003c/p\u003e\\n\u003cp\u003e더불어, 메시지는 반드시 서비스가 발송한 순서대로 메시지 브로커에 도착해야 한다. 예를 들면, 서비스에서 한 aggregate이 트랜잭션 \u003ccode\u003eT1\u003c/code\u003e, \u003ccode\u003eT2\u003c/code\u003e에 의해 업데이트 된다고 하자. 두 트랜잭션은  같은 서비스 인스턴스에서 수행될 수도 있고 다른 서비스 인스턴스에서 수행될 수도 있다. 각각 트랜잭션은 대응되는 이벤트 \u003ccode\u003eE1\u003c/code\u003e, \u003ccode\u003eE2\u003c/code\u003e가 있다. 이 때 만일 트랜잭션 \u003ccode\u003eT1\u003c/code\u003e 다음에 \u003ccode\u003eT2\u003c/code\u003e가 수행된다면, 이벤트 \u003ccode\u003eE2\u003c/code\u003e는 반드시 \u003ccode\u003eE1\u003c/code\u003e 다음에 발행되어야 한다.\u003c/p\u003e\\n\u003ch2 id=\\\"problem\\\"\u003eProblem\u003c/h2\u003e\\n\u003cp\u003e어떻게 데이터베이스 업데이트와 메시지/이벤트 발행을 안정적/원자적으로 할 수 있을까?\u003c/p\u003e\\n\u003ch2 id=\\\"forces\\\"\u003eForces\u003c/h2\u003e\\n\u003cul\u003e\\n\u003cli\u003e2PC는 사용하지 않는다.\u003c/li\u003e\\n\u003cli\u003e만약 데이터베이스 트랜잭션이 커밋됐다면, 메시지는 반드시 발송되어야 한다. 반대로 데이터베이스가 롤백되었다면, 메시지는 발송되지 않아야 한다.\u003c/li\u003e\\n\u003cli\u003e메시지는 반드시 서비스가 발송한 순서대로 메시지 브로커에 도착해야 한다. 같은 aggregate을 업데이트하는 다수에 서비스 인스턴스에 걸쳐서 이 순서는 반드시 지켜져야 한다.\u003c/li\u003e\\n\u003c/ul\u003e\\n\u003ch2 id=\\\"solution\\\"\u003eSolution\u003c/h2\u003e\\n\u003cp\u003e관계형 데이터베이스를 사용하는 서비스는 \u003cem\u003eoutbox\u003c/em\u003e 테이블(e.g. \u003ccode\u003eMESSAGE\u003c/code\u003e)에 메시지/이벤트를 로컬 트랜잭션으로 insert 한다. NoSQL 데이터베이스를 사용하는 서비스는 메시지/이벤트를 record(e.g. document 또는 item) attribute를 추가하는 방식으로 업데이트 한다. 별도의 \u003cem\u003e메시지 릴레이\u003c/em\u003e 프로세스는 데이터베이스에 추가 된 이벤트를 메시지 브로커로 발행한다.\u003c/p\u003e\\n\u003cp\u003e\u003cimg src=\\\"https://user-images.githubusercontent.com/10704195/201923714-be54b86b-605c-417b-82d1-9a3149289c36.png\\\" alt=\\\"image\\\"\u003e\u003c/p\u003e\\n\u003ch2 id=\\\"result-context\\\"\u003eResult context\u003c/h2\u003e\\n\u003cp\u003e이 패턴은 아래와 같은 장점이 있다.\u003c/p\u003e\\n\u003cul\u003e\\n\u003cli\u003e2PC를 사용하지 않는다.\u003c/li\u003e\\n\u003cli\u003e데이터베이스 트랜잭션이 커밋된 경우에만 메시지가 발송 되는 것을 보장 한다.\u003c/li\u003e\\n\u003cli\u003e메시지는 어플리캐이션에 의해 발송된 순서대로 메시지 브로커에 도착한다.\u003c/li\u003e\\n\u003c/ul\u003e\\n\u003cp\u003e이 패턴은 아래와 같은 단점이 있다.\u003c/p\u003e\\n\u003cul\u003e\\n\u003cli\u003e개발자가 데이터베이스 업데이트 후에 메시지/이벤트를 발행하는 것을 잊어버릴 수 있기 때문에 잠재적으로 에러가 발생할 수 있다.\u003c/li\u003e\\n\u003c/ul\u003e\\n\u003cp\u003e이 패턴은 또한 아래 이슈가 있다.\u003c/p\u003e\\n\u003cul\u003e\\n\u003cli\u003e메시지 릴레이는 같은 메시지를 중복해서 발행할 수 있다. 예를 들면, 메시지를 발행한 후 발행 여부를 기록하기 전에 크래시가 일어나, 이를 재실행 하면서 메시지를 다시 발행할 수 있다. 따라서, 메시지 컨슈머는 이미 처리한 동일한 메시지에 대해서 반드시 멱등하게 동작해야 한다. 다행히도 메시지 컨슈머는 보통 멱등하게 동작하므로 (브로커는 메시지를 여러번 보낼 수 있다) 이 것이 문제되지 않는다.\u003c/li\u003e\\n\u003c/ul\u003e\\n\u003ch2 id=\\\"related-patterns\\\"\u003eRelated patterns\u003c/h2\u003e\\n\u003cul\u003e\\n\u003cli\u003e\u003ca href=\\\"https://microservices.io/patterns/data/saga.html\\\"\u003eSaga\u003c/a\u003e와 \u003ca href=\\\"https://microservices.io/patterns/data/domain-event.html\\\"\u003eDomain event\u003c/a\u003e 패턴에 이 패턴이 사용된다.\u003c/li\u003e\\n\u003cli\u003e\u003ca href=\\\"https://microservices.io/patterns/data/event-sourcing.html\\\"\u003eEvent sourcing\u003c/a\u003e은 이 솔루션의 다른 대안이다.\u003c/li\u003e\\n\u003cli\u003e\u003cem\u003e메시지 릴레이\u003c/em\u003e를 구현하는데 아래 두 패턴이 사용된다.\u003cul\u003e\\n\u003cli\u003e\u003ca href=\\\"https://microservices.io/patterns/data/transaction-log-tailing.html\\\"\u003eTransaction log tailing\u003c/a\u003e 패턴\u003c/li\u003e\\n\u003cli\u003e\u003ca href=\\\"https://microservices.io/patterns/data/polling-publisher.html\\\"\u003ePolling publisher\u003c/a\u003e 패턴\u003c/li\u003e\\n\u003c/ul\u003e\\n\u003c/li\u003e\\n\u003c/ul\u003e\\n\u003ch2 id=\\\"learn-more\\\"\u003eLearn more\u003c/h2\u003e\\n\u003cul\u003e\\n\u003cli\u003e책 ‘\u003ca href=\\\"https://microservices.io/book\\\"\u003eMicroservices patterns\u003c/a\u003e’에 더 자세한 설명이 있다.\u003c/li\u003e\\n\u003cli\u003e\u003ca href=\\\"https://github.com/eventuate-tram/eventuate-tram-core\\\"\u003eEventuate Tram framework\u003c/a\u003e는 이 패턴의 구현체이다.\u003c/li\u003e\\n\u003c/ul\u003e\\n\"}],null],\"segment\":\"__PAGE__?{\\\"slug\\\":\\\"Transactional-outbox\\\"}\"},\"styles\":[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/e175a87955b7f53c.css\",\"precedence\":\"next\"}]]}],\"segment\":[\"slug\",\"Transactional-outbox\",\"d\"]},\"styles\":[]}],\"segment\":\"articles\"},\"styles\":[]}]}],[\"$\",\"footer\",null,{\"children\":[\"$\",\"span\",null,{\"children\":[\"Github (\",[\"$\",\"a\",null,{\"href\":\"https://github.com/juchanei\",\"children\":\"@juchanei\"}],\")\"]}]}]]}]}]]}],null]}]]\n"])</script><script>self.__next_f.push([1,"5:[[[\"$\",\"meta\",null,{\"charSet\":\"utf-8\"}],null,null,null,null,null,null,null,null,null,null,[\"$\",\"meta\",null,{\"name\":\"viewport\",\"content\":\"width=device-width, initial-scale=1\"}],null,null,null,null,null,null,null,null,null,null,[]],[null,null,null,null],null,null,[null,null,null,null,null],null,null,null,null,null]\n"])</script>